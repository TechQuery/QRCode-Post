//
//  Generated by https://www.npmjs.com/package/amd-bundle
//
(function (factory) {

    if ((typeof define === 'function')  &&  define.amd)
        define('index', factory);
    else if (typeof module === 'object')
        return  module.exports = factory();
    else
        return  this['index'] = factory();

})(function () {

function merge(base, path) {

    return (base + '/' + path).replace(/\/\//g, '/').replace(/[^/.]+\/\.\.\//g, '').replace(/\.\//g, function (match, index, input) {

        return input[index - 1] === '.' ? match : '';
    });
}

function outPackage(name) {
    return (/^[^./]/.test(name)
    );
}

    var require = _require_.bind(null, './');

    function _require_(base, path) {

        var module = _module_[
                outPackage( path )  ?  path  :  ('./' + merge(base, path))
            ],
            exports;

        if (! module.exports) {

            module.exports = { };

            var dependency = module.dependency;

            for (var i = 0;  dependency[i];  i++)
                module.dependency[i] = require( dependency[i] );

            exports = module.factory.apply(
                null,  module.dependency.concat(
                    _require_.bind(null, module.base),  module.exports,  module
                )
            );

            if (exports != null)  module.exports = exports;

            delete module.dependency;  delete module.factory;
        }

        return module.exports;
    }

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var _module_ = {
    './Drawer': {
        base: '.',
        dependency: [],
        factory: function factory(require, exports, module) {
            Object.defineProperty(exports, "__esModule", {
                value: true
            });

            var Drawer = function () {
                function Drawer(canvas) {
                    _classCallCheck(this, Drawer);

                    this.canvas = canvas instanceof Element ? canvas : document.querySelector(canvas);

                    this.context = this.canvas.getContext('2d');
                }

                _createClass(Drawer, [{
                    key: 'draw',
                    value: function draw(image, x, y, width, height) {

                        this.context.drawImage(image, x || 0, y || 0, width || image.naturalWidth, height || image.naturalHeight);
                    }
                }, {
                    key: 'drawBackground',
                    value: function drawBackground(image) {

                        this.canvas.width = image.naturalWidth, this.canvas.height = image.naturalHeight;

                        this.draw(image);
                    }
                }, {
                    key: 'coordOf',
                    value: function coordOf(event) {

                        return [event.clientX - this.canvas.offsetLeft, event.clientY - this.canvas.offsetTop];
                    }
                }, {
                    key: 'clear',
                    value: function clear() {

                        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

                        this.canvas.width = this.canvas.height = 0;
                    }
                }]);

                return Drawer;
            }();

            exports.default = Drawer;
        }
    },
    './utility': {
        base: '.',
        dependency: [],
        factory: function factory(require, exports, module) {
            Object.defineProperty(exports, "__esModule", {
                value: true
            });
            exports.read = read;
            exports.imageOf = imageOf;
            exports.QRCodeOf = QRCodeOf;
            exports.squareOf = squareOf;
            function read(file) {

                var reader = new FileReader();

                return new Promise(function (resolve, reject) {

                    reader.onload = function () {
                        return resolve(reader.result);
                    };

                    reader.onerror = reject;

                    reader.readAsDataURL(file);
                });
            }

            function imageOf(URI) {

                var image = new Image();

                return new Promise(function (resolve, reject) {

                    image.onload = function () {
                        return resolve(image);
                    }, image.onerror = reject;

                    image.src = URI;
                });
            }

            function QRCodeOf(raw) {

                var code = qrcode(0, 'H');

                code.addData(raw);

                code.make();

                return code.createDataURL();
            }

            function squareOf(rect) {

                var size = [rect[1][0] - rect[0][0], rect[1][1] - rect[0][1]];

                var square = [rect[0]];

                square[1] = size[0] < size[1] ? [rect[1][0], rect[0][1] + size[0]] : [rect[0][0] + size[1], rect[1][1]];

                return square;
            }
        }
    },
    './index': {
        base: '.',
        dependency: [],
        factory: function factory(require, exports, module) {
            var _this = this;

            var _utility = require('./utility');

            var _Drawer = require('./Drawer');

            var _Drawer2 = _interopRequireDefault(_Drawer);

            function _interopRequireDefault(obj) {
                return obj && obj.__esModule ? obj : { default: obj };
            }

            var drawer = new _Drawer2.default('canvas');

            // Load image

            var form = document.querySelector('form');

            form.image.onchange = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
                var image;
                return regeneratorRuntime.wrap(function _callee$(_context) {
                    while (1) {
                        switch (_context.prev = _context.next) {
                            case 0:
                                image = this.files[0];

                                if (!image) {
                                    _context.next = 13;
                                    break;
                                }

                                _context.t0 = drawer;
                                _context.t1 = (0, _utility.imageOf);
                                _context.next = 6;
                                return (0, _utility.read)(image);

                            case 6:
                                _context.t2 = _context.sent;
                                _context.next = 9;
                                return (0, _context.t1)(_context.t2);

                            case 9:
                                _context.t3 = _context.sent;

                                _context.t0.drawBackground.call(_context.t0, _context.t3);

                                _context.next = 14;
                                break;

                            case 13:
                                drawer.clear();

                            case 14:
                            case 'end':
                                return _context.stop();
                        }
                    }
                }, _callee, this);
            }));

            // Select area

            var output = document.querySelectorAll('form [readonly]'),
                rect = [];

            drawer.canvas.onmousedown = function (event) {

                rect[0] = output[0].value = drawer.coordOf(event);

                rect[1] = null;
            };

            drawer.canvas.onmouseup = drawer.canvas.onmouseout = function (event) {

                if (rect[0] && !rect[1]) rect[1] = output[1].value = drawer.coordOf(event);
            };

            // Print QRCode

            form.onsubmit = function () {
                var _ref2 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(event) {
                    var image, square;
                    return regeneratorRuntime.wrap(function _callee2$(_context2) {
                        while (1) {
                            switch (_context2.prev = _context2.next) {
                                case 0:

                                    event.preventDefault();

                                    _context2.next = 3;
                                    return (0, _utility.imageOf)((0, _utility.QRCodeOf)(this.URL.value));

                                case 3:
                                    image = _context2.sent;

                                    if (!(rect.length < 2)) {
                                        _context2.next = 6;
                                        break;
                                    }

                                    return _context2.abrupt('return', drawer.draw(image));

                                case 6:
                                    square = (0, _utility.squareOf)(rect);


                                    drawer.draw(image, square[0][0], square[0][1], square[1][0] - square[0][0], square[1][1] - square[0][1]);

                                case 8:
                                case 'end':
                                    return _context2.stop();
                            }
                        }
                    }, _callee2, this);
                }));

                return function (_x) {
                    return _ref2.apply(this, arguments);
                };
            }();

            form.onreset = function () {

                drawer.clear();

                rect.length = 0;

                var _iteratorNormalCompletion = true;
                var _didIteratorError = false;
                var _iteratorError = undefined;

                try {
                    for (var _iterator = Array.from(form.elements)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                        var field = _step.value;
                        field.disabled = false;
                    }
                } catch (err) {
                    _didIteratorError = true;
                    _iteratorError = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion && _iterator.return) {
                            _iterator.return();
                        }
                    } finally {
                        if (_didIteratorError) {
                            throw _iteratorError;
                        }
                    }
                }
            };

            // Preset parameters

            _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {
                var parameter, image, start, end;
                return regeneratorRuntime.wrap(function _callee3$(_context3) {
                    while (1) {
                        switch (_context3.prev = _context3.next) {
                            case 0:
                                parameter = new URLSearchParams(location.search);
                                image = parameter.get('image'), start = parameter.get('start'), end = parameter.get('end');

                                if (!image) {
                                    _context3.next = 9;
                                    break;
                                }

                                _context3.t0 = drawer;
                                _context3.next = 6;
                                return (0, _utility.imageOf)(image);

                            case 6:
                                _context3.t1 = _context3.sent;

                                _context3.t0.drawBackground.call(_context3.t0, _context3.t1);

                                form.image.disabled = true;

                            case 9:

                                if (start) {

                                    form.start.value = rect[0] = start.split(',');

                                    rect[0][0] = +rect[0][0], rect[0][1] = +rect[0][1];

                                    form.start.disabled = true;
                                }

                                if (end) {

                                    form.end.value = rect[1] = end.split(',');

                                    rect[1][0] = +rect[1][0], rect[1][1] = +rect[1][1];

                                    form.end.disabled = true;
                                }

                            case 11:
                            case 'end':
                                return _context3.stop();
                        }
                    }
                }, _callee3, _this);
            }))();
        }
    }
};

    return require('./index');
});